name: Push to Kubernetes

on:
    workflow_dispatch:
      inputs:
        new_namespace:
          description: 'New Namespace'
          type: boolean
          default: true
          required: true

env:
    NAMESPACE: ${{ vars.NAMESPACE }}
    GIT_REGISTRY: ghcr.io
    GIT_REPO_OWNER: richardvanraes
    GIT_IMAGE_NAME: mlops-2.0
    GIT_SHA: ${{ github.sha }} # Set the SHA to use in the code

jobs:
  namespace:
    if: ${{ inputs.new_namespace 
      }}
    runs-on: self-hosted
    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
        # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
        # - uses: actions/checkout@v3
  
        # Create a new namespace
        - name: Create Namespace
          run: kubectl create namespace ${{ env.NAMESPACE }}
  
  pull:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v2
      
      # Login to GHCR
      - name: Login to GHCR
        uses: docker/login-action@v1
        with:
          registry: ${{ env.GIT_REGISTRY }}
          username: ${{ github.repository_owner }}
          password: ${{ secrets.TOKEN_GITHUB }}  

      - name: Gather Github short SHA
        id: get_sha
        run: echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      # Pull a Docker image
      - name: Pull Docker image
        run: docker pull ${{ env.GIT_REGISTRY }}/${{ env.GIT_REPO_OWNER }}/${{ env.GIT_IMAGE_NAME }}:sha-${{ steps.get_sha.outputs.sha_short }}
        
         # A KubeCTL action which will apply a Kubernetes object to your cluster
      - name: Run KubeCtl
        run: kubectl create -f ./kubernetes/deployment.yml -n ${{ env.NAMESPACE }}